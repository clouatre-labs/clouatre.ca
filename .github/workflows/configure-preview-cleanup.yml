name: Configure Preview Cleanup

# One-time workflow to configure Cloudflare Pages preview deployment cleanup
# Run this manually, then delete this file

on:
  workflow_dispatch:

jobs:
  configure:
    runs-on: ubuntu-24.04
    steps:
      - name: Configure Cloudflare Pages preview cleanup
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Get project details first
          PROJECT_NAME="clouatre-ca"
          
          echo "Fetching current project configuration..."
          CURRENT_CONFIG=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${PROJECT_NAME}" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json")
          
          echo "Current config:"
          echo "$CURRENT_CONFIG" | jq '.result.deployment_configs.preview.preview_deployment_setting // "not set"'
          
          echo ""
          echo "Setting preview deployment cleanup to 7 days..."
          
          # Update project to delete preview deployments after 7 days
          RESULT=$(curl -s -X PATCH \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${PROJECT_NAME}" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "deployment_configs": {
                "preview": {
                  "preview_deployment_setting": "custom",
                  "preview_branch_excludes": [],
                  "preview_branch_includes": ["*"],
                  "preview_deployment_ttl_hours": 168
                }
              }
            }')
          
          echo ""
          echo "API Response:"
          echo "$RESULT" | jq '.'
          
          # Check if successful
          if echo "$RESULT" | jq -e '.success == true' > /dev/null; then
            echo ""
            echo "✅ Successfully configured preview cleanup:"
            echo "   - Preview deployments will be deleted after 7 days (168 hours)"
            echo "   - All preview branches included"
            echo ""
            echo "You can now delete this workflow file (.github/workflows/configure-preview-cleanup.yml)"
          else
            echo ""
            echo "❌ Configuration failed. Check the API response above."
            exit 1
          fi
